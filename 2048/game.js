const t=document.getElementById("game"),i=t.getContext("2d"),s=document.getElementById("score"),h=((window.location.hash.match(/#([^?]*)/)||[])[1],2),n=100;let e=0;t.height=t.width=4*n;const o=Object.freeze({t:37,i:38,s:39,h:40});let r={o:[],l:"active",u:function(t,i){try{return this.o[t][i]}catch(t){return}},F:function(t,s,e){return this.o[t][s]=new function(t,s,e){this.m=e,this.p=t,this.g=s,this.k=null,this.v=function(){return parseInt(this.m)},this.A=function(){this.m*=2},this.M=function(t){this.k&&(this.k.p=this.p,this.k.g=this.g,this.k.M(t));const s=t-(this.W||t);this.W=t,null==this.C&&(this.C=-n),null==this.x&&(this.x=n*this.g),null==this.y&&(this.y=n*this.p);const e=n*this.g,o=n*this.p;let r=!1;this.x>e?(r=!0,this.x-=h*s,this.x<e&&(this.x=e)):this.x<e&&(r=!0,this.x+=h*s,this.x>e&&(this.x=e)),this.y>o?(r=!0,this.y-=h*s,this.y<o&&(this.y=o)):this.y<o&&(r=!0,this.y+=h*s,this.y>o&&(this.y=o)),!1===r&&(this.I=this.m,this.k=(this.k||{k:null}).k),this.C>0&&(i.fillStyle="#000000",i.fillRect(this.x+(n-this.C)/2,this.y+(n-this.C)/2,this.C,this.C),i.textAlign="center",i.textBaseline="middle",i.font=n/2+"px Arial",i.fillStyle="#FF0000",i.fillText(this.I,this.x+n/2,this.y+n/2,this.C)),this.C<n-2&&(this.C+=s*h/2),this.C>n-2&&(this.C=n-2)}}(t,s,e)},L:function(){let t=[];for(let i=0;i<4;i++)for(let s=0;s<4;s++)this.o[i][s]||t.push([i,s]);if(0==t.length)return;const i=this.F(...t[Math.floor(Math.random()*t.length)],2);Math.random()<.1&&i.A()},O:function(t){let i;switch(t){case o.t:i=((t,i)=>[t,i]);break;case o.i:i=((t,i)=>[i,t]);break;case o.s:i=((t,i)=>[t,3-i]);break;case o.h:i=((t,i)=>[3-i,t]);break;default:return}let s=!1;const h=this;function n(t,i,n){t.p==i&&t.g==n||(h.o[t.p][t.g]=void 0,h.o[i][n]=t,t.p=i,t.g=n,s=!0)}for(let t=0;t<4;t++){let s=[];for(let h=0;h<4;h++){const n=this.u(...i(t,h));n&&s.push(n)}for(let h=0;h<s.length;h++)n(s[h],...i(t,h)),h+1<s.length&&s[h].m==s[h+1].m&&(n(s[h+1],...i(t,h)),s[h+1].A(),e+=s[h+1].v(),2048==s[h+1].m&&(this.l="win"),s[h+1].k=s.splice(h,1)[0])}return s},P:function(){for(let t=0;t<4;t++)for(let i=0;i<4;i++){if(!this.o[t][i])return;const s=this.o[t][i].m;if(s==(this.u(t+1,i)||{}).m)return;if(s==(this.u(t,i+1)||{}).m)return}this.l="lose"},M:function(s){i.clearRect(0,0,t.width,t.height),this.o.forEach(t=>t.forEach(t=>{t&&t.M(s)})),"win"==this.l?(i.fillStyle="rgba(0, 100, 255, 0.6)",i.fillRect(0,0,t.height,t.width),i.textAlign="center",i.textBaseline="middle",i.font=n+"px Arial",i.fillStyle="#FFFFFF",i.fillText("You Win!",t.height/2,t.width/2,t.width)):"lose"==this.l&&(i.fillStyle="rgba(255, 0, 100, 0.6)",i.fillRect(0,0,t.height,t.width),i.textAlign="center",i.textBaseline="middle",i.font=n+"px Arial",i.fillStyle="#FFFFFF",i.fillText("You Lose",t.height/2,t.width/2,t.width))}};for(let t=0;t<4;t++)r.o[t]=[];document.onkeydown=function(t){"active"==r.l&&r.O(t.keyCode)&&(r.L(),r.P(),s.innerHTML="Score: "+e)},r.L(),r.L(),window.requestAnimationFrame(function t(i){r.M(i),window.requestAnimationFrame(t)});